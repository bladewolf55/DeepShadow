<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <!-- Convention: Folders are not \ appended.-->
  <PropertyGroup>
    <Configuration Condition=" '$(Configuration)' == '' ">Release</Configuration>
    <SolutionDir>$(MSBuildProjectDirectory)\..</SolutionDir>
    <ProjectToPublish>..\DeepShadow\DeepShadow.csproj</ProjectToPublish> <!-- CHANGE -->
    <NuGetFileToPack>..\DeepShadow\DeepShadow.csproj</NuGetFileToPack> <!-- CHANGE -->
    <NuGetExe>NuGet.exe</NuGetExe>
    <NuGetPackageDir>NuGetPackage</NuGetPackageDir>
    <NuGetRepositoryDir>Published</NuGetRepositoryDir> <!-- CHANGE -->
    <OverwritePackage>only overwrite if value is true</OverwritePackage>
  </PropertyGroup>

  <ItemGroup>
    <BinDir Include="Bin" />
    <SolutionPath Include="$(SolutionDir)\*.sln" />
  </ItemGroup>

  <!-- ***** Create Nuspec *****-->
  <Target Name="Nuspec">
    <PropertyGroup>
      <ProjectDir>$([System.IO.Path]::GetDirectoryName('$(ProjectToPublish)'))</ProjectDir>
      <NuSpecCommand>"$(MSBuildProjectDirectory)\$(NuGetExe)" spec</NuSpecCommand>
    </PropertyGroup>
    <Message Text="$(ProjectDir)" />
    <Message Text="$(NuSpecCommand)" />
    <Exec Command="$(NuSpecCommand)" WorkingDirectory="$(ProjectDir)" />
  </Target>

  <!-- ***** BUILD ***** -->
  <Target Name="Build" DependsOnTargets="Init">
    <Message Text="Build entire solution, using default output folders" />
    <MSBuild
      Projects="@(SolutionPath)"
      Targets="Rebuild"
      Properties="Configuration=$(Configuration)"
      />

    <Message Text="Build the project that will be published, using the custom BIN folder" />
    <MSBuild
      Projects="$(ProjectToPublish)"
      Targets="Rebuild"
      Properties="OutDir=%(BinDir.FullPath);Configuration=$(Configuration)"
      />

  </Target>

  <Target Name="Clean">
    <RemoveDir Directories= "@(BinDir)" />
  </Target>

  <Target Name="Init" DependsOnTargets="Clean">
    <MakeDir Directories="@(BinDir)" />
  </Target>

  <!-- ***** PACKAGE ***** -->
  <!-- 
    We're overriding the project file's OutputPath to our own.
    Pack uses the project file in order to include any other package dependencies.
    The project.nuspec file has paths to other files to be included.
  -->
  <PropertyGroup>
    <PackageCommand>"$(NuGetExe)" pack "$(NuGetFileToPack)" -o $(NuGetPackageDir) -p OutputPath="@(BinDir->'%(FullPath)')"</PackageCommand>
  </PropertyGroup>

  <Target Name="Package" AfterTargets="Build">
    <RemoveDir Directories="$(NuGetPackageDir)" />
    <MakeDir Directories="$(NuGetPackageDir)" />
    <Exec Command="$(PackageCommand)" />
  </Target>


  <!-- ***** PUBLISH *****-->
  <Target Name="Publish">
    <PropertyGroup>
      <!-- Set properties when target runs so we get current file contents-->
      <NuGetPackageFile>$([System.IO.Directory]::GetFiles('$(NuGetPackageDir)',"*.nupkg")[0])</NuGetPackageFile>
      <NuGetPackageFileName>$([System.IO.Path]::GetFileName('$(NuGetPackageFile)'))</NuGetPackageFileName>
      <NuGetRemoteFile>$(NuGetRepositoryDir)\$(NuGetPackageFileName)</NuGetRemoteFile>
    </PropertyGroup>

    <Message Text="OverwritePackage is TRUE" Condition="'$(OverwritePackage)' == 'true'" />
    <Error Text=" PUBLISH FAILED! The target package already exists." Condition="'$(OverwritePackage)' != 'true' AND Exists('$(NuGetRemoteFile)')"/>
    <Copy SourceFiles="$(NuGetPackageFile)" DestinationFolder="$(NuGetRepositoryDir)" />
  </Target>

  
  
  
</Project>